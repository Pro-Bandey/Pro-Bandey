name: Generate Snake

# REQUIRED: allow git push to branches like "output"
permissions:
  contents: write

on:
  push:
  workflow_dispatch:

jobs:
  # --------------------------------------------------
  # TEST PROJECT
  # --------------------------------------------------
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: npm run type

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: bun test

  # --------------------------------------------------
  # TEST ACTION (FULL: SVG + GIF)
  # --------------------------------------------------
  test-action:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use local Dockerfile for action
        run: sed -i "s/image: .*/image: Dockerfile/" action.yml

      - name: Generate snake (full)
        uses: ./
        with:
          github_user_name: platane
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
            dist/github-contribution-grid-snake-ocean.svg?color_snake=orange&color_dots=#dadcdf94,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            dist/github-contribution-grid-snake-grey.svg?color_snake=111&color_dots=#eee,#aaa,#888,#666,#444
            dist/github-contribution-grid-snake.gif
            dist/github-contribution-grid-snake-dark.gif?palette=github-dark
            dist/github-contribution-grid-snake-ocean.gif?color_snake=orange&color_dots=#dadcdf94,#8dbdff,#64a1f4,#4b91f1,#3c7dd9&color_background=#f7f8fa

      - name: Verify output files
        run: |
          ls dist
          test -f dist/github-contribution-grid-snake.svg
          test -f dist/github-contribution-grid-snake-dark.svg
          test -f dist/github-contribution-grid-snake-ocean.svg
          test -f dist/github-contribution-grid-snake-grey.svg
          test -f dist/github-contribution-grid-snake.gif
          test -f dist/github-contribution-grid-snake-dark.gif
          test -f dist/github-contribution-grid-snake-ocean.gif

      - name: Publish to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --------------------------------------------------
  # TEST ACTION (SVG ONLY)
  # --------------------------------------------------
  test-action-svg-only:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build svg-only action
        run: |
          npm run build:action
          rm -rf svg-only/dist
          mv packages/action/dist svg-only/dist

      - name: Generate snake (svg-only)
        uses: ./svg-only
        with:
          github_user_name: platane
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
            dist/github-contribution-grid-snake-ocean.svg?color_snake=orange&color_dots=#dadcdf94,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            dist/github-contribution-grid-snake-grey.svg?color_snake=111&color_dots=#eee,#aaa,#888,#666,#444

      - name: Verify svg files
        run: |
          ls dist
          test -f dist/github-contribution-grid-snake.svg
          test -f dist/github-contribution-grid-snake-dark.svg
          test -f dist/github-contribution-grid-snake-ocean.svg
          test -f dist/github-contribution-grid-snake-grey.svg

      - name: Publish svg-only output
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output-svg-only
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --------------------------------------------------
  # DEPLOY DEMO TO GITHUB PAGES + CLOUDFLARE
  # --------------------------------------------------
  deploy-ghpages:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build demo
        run: npm run build:demo
        env:
          GITHUB_USER_CONTRIBUTION_API_ENDPOINT: https://github-user-contribution.platane.workers.dev/github-user-contribution/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: packages/demo/dist

      - name: Deploy Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/deploy-pages@v4

      - name: Deploy Cloudflare Worker
        if: github.ref == 'refs/heads/main'
        run: bun wrangler deploy
        working-directory: packages/github-user-contribution-service
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
